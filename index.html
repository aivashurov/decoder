
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–æ–∫</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 150px; font-family: monospace; font-size: 14px; }
    button { padding: 10px 20px; font-size: 14px; margin-top: 10px; margin-right: 10px; }
    pre { background: #f0f0f0; padding: 15px; white-space: pre-wrap; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea><br />
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>

<script>
let airports = {};
let aliasMap = {};
let statuses = {};

function fetchCSV(url) {
  return fetch(url)
    .then(response => response.text())
    .then(text => {
      const lines = text.trim().split(/\r?\n/);
      const [header, ...rows] = lines;
      const keys = header.split(',');
      return rows.map(row => {
        const values = row.split(',');
        const obj = {};
        keys.forEach((key, i) => obj[key.trim()] = values[i] ? values[i].trim() : "");
        return obj;
      });
    });
}

function init() {
  Promise.all([
    fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv"),
    fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv")
  ]).then(([airportData, statusData]) => {
    airportData.forEach(a => {
      airports[a.code] = { city: capitalize(a.city), iata: a.iata };
      if (a.alias) {
        a.alias.split(' ').forEach(alias => {
          aliasMap[alias.toUpperCase()] = a.code;
        });
      }
    });
    statusData.forEach(s => {
      statuses[s.code.toUpperCase()] = s.description;
    });
  }).catch(err => {
    document.getElementById("output").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + err;
  });
}

function capitalize(str) {
  return str
    ? str
        .split(/([ -])/g)
        .map(w =>
          /[–ê-–ØA-Z–Å]/i.test(w.charAt(0))
            ? w.charAt(0).toUpperCase() + w.slice(1)
            : w
        )
        .join('')
    : '';
}

function matchRoute(routeToken) {
  for (let len = 3; len <= 4; len++) {
    let from = routeToken.slice(0, len);
    let to = routeToken.slice(len);
    const fromMatch = aliasMap[from] || (airports[from] ? from : null);
    const toMatch = aliasMap[to] || (airports[to] ? to : null);
    if (fromMatch && toMatch) {
      return [fromMatch, toMatch];
    }
  }
  return [null, null];
}

function decode() {
  const text = document.getElementById("input").value.trim();
  const output = [];
  const lines = text.split(/\n+/);

  for (const line of lines) {
    const tokens = line.trim().toUpperCase().split(/\s+/);

    let airline = "", flight = "", dateToken = "", dep = "", arr = "", status = "";
    let fromCode = "", toCode = "";

    if (/^[A-Z]{2}$/.test(tokens[0]) && /^[0-9]{2,4}$/.test(tokens[1])) {
      airline = tokens[0];
      flight = tokens[1];
    } else if (/^[A-Z0-9]{2}-[0-9]{2,4}$/.test(tokens[0])) {
      [airline, flight] = tokens[0].split("-");
    }

    dateToken = tokens.find(t => /^\d{2}[A-Z–ê-–Ø–Å]{3}(\d{2})?$/i.test(t)) || "";
    const months = {
      "–Ø–ù–í":"01","–§–ï–í":"02","–ú–ê–†":"03","–ê–ü–†":"04","–ú–ê–ô":"05","–ò–Æ–ù":"06",
      "–ò–Æ–õ":"07","–ê–í–ì":"08","–°–ï–ù":"09","–û–ö–¢":"10","–ù–û–Ø":"11","–î–ï–ö":"12",
      "JAN":"01","FEB":"02","MAR":"03","APR":"04","MAY":"05","JUN":"06",
      "JUL":"07","AUG":"08","SEP":"09","OCT":"10","NOV":"11","DEC":"12"
    };
    let formattedDate = "‚ö†Ô∏è";
    if (dateToken.length >= 5) {
      const d = dateToken.slice(0,2);
      const m = months[dateToken.slice(2,5).toUpperCase()] || "??";
      const y = dateToken.length === 7 ? "20"+dateToken.slice(5) : "2025";
      formattedDate = `${d}.${m}.${y}`;
    }

    const routeToken = tokens.find(t =>
  t.length >= 6 && t.length <= 8 && /^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t.replace(/[^\w–ê-–Ø–∞-—èA-Za-z]/g, ""))
) || "";


    [fromCode, toCode] = matchRoute(routeToken);

    const from = airports[fromCode?.toUpperCase()];
    const to = airports[toCode?.toUpperCase()];

    const statusToken = tokens.find(t => statuses[t.toUpperCase()]);
    status = statuses[statusToken] || "";

    const times = tokens.filter(t => /^\d{4}$/.test(t));
    dep = times[times.length - 2] || "";
    arr = times[times.length - 1] || "";
    if (dep.length === 4) dep = dep.slice(0,2) + ":" + dep.slice(2);
    if (arr.length === 4) arr = arr.slice(0,2) + ":" + arr.slice(2);

    console.log("üß© routeToken:", routeToken);
    console.log("‚úÖ fromCode:", fromCode, "‚Üí", airports[fromCode?.toUpperCase()]);
    console.log("‚úÖ toCode:", toCode, "‚Üí", airports[toCode?.toUpperCase()]);
    console.log("‚úÖ dep:", dep, "‚úÖ arr:", arr);
    console.log("‚úÖ status:", statusToken, "‚Üí", statuses[statusToken?.toUpperCase()]);
    console.log("‚úÖ dateToken:", dateToken);
    console.log("‚úÖ formattedDate:", formattedDate);
    console.log("‚úÖ airline:", airline);
    console.log("‚úÖ flight:", flight);
    
    if (airline && flight && from && to && dep && arr && formattedDate) {
      output.push(`${airline}-${flight} ${formattedDate}, ${from.city} ${from.iata} ${dep} ‚Äî ${to.city} ${to.iata} ${arr}${status ? " ‚Äî " + status : ""}`);
    } else {
      output.push("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: " + line);
    }
  }

  document.getElementById("output").textContent = output.join("\n");
}

function copyResult() {
  navigator.clipboard.writeText(document.getElementById("output").textContent);
}

function clearAll() {
  document.getElementById("input").value = "";
  document.getElementById("output").textContent = "";
}

init();
</script>
</body>
</html>
