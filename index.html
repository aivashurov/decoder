<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</title>
  <style>
    body.dark-mode { background-color: #121212; color: #eee; }
    body.dark-mode textarea,
    body.dark-mode pre#output { background-color: #1e1e1e; color: #fff; border: 1px solid #444; }
    body.dark-mode button { background-color: #2c2c2c; color: #eee; border: 1px solid #555; }
    body.transition,
    body.transition * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    .dark-toggle { position: absolute; top: 10px; right: 10px; cursor: pointer; background: #333; color: #eee; border: 1px solid #666; padding: 6px; border-radius: 6px; }
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea { width: 100%; height: 150px; font-family: monospace; font-size: 14px; }
    button { padding: 8px 16px; margin: 4px; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
  <script>
    function toggleDarkMode() {
      document.body.classList.add('transition');
      document.body.classList.toggle('dark-mode');
      const btn = document.getElementById('theme-toggle');
      btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
      setTimeout(() => document.body.classList.remove('transition'), 300);
    }
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      }
    });
  </script>

  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea><br/>
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>

<script>
let airports = {}, aliasMap = {}, statuses = {};

function isCyrillic(s) { return /[–ê-–Ø–Å–∞-—è—ë]/.test(s); }
function transliterateCyrillic(s) {
  const map = { '–ê':'A','–í':'B','–ï':'E','–ö':'K','–ú':'M','–ù':'N','–û':'O','–†':'P','–°':'S','–¢':'T','–£':'U','–•':'X','–§':'F','–≠':'E','–Å':'E','–Ø':'YA','–Æ':'YU','–ñ':'ZH','–®':'SH','–©':'SHCH' };
  return [...s].map(ch => map[ch]||ch).join('');
}
function normalizeToken(s) {
  const up = s.toUpperCase();
  return isCyrillic(up) ? transliterateCyrillic(up) : up;
}

function fetchCSV(url) {
  return fetch(url).then(r => r.text()).then(text => {
    const [h, ...rows] = text.trim().split(/\r?\n/);
    const keys = h.split(',');
    return rows.map(r => {
      const vals = r.split(','); let obj = {};
      keys.forEach((k,i) => obj[k.trim()] = vals[i]?.trim()||"");
      return obj;
    });
  });
}

function init() {
  Promise.all([
    fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/main/airports_cleaned.csv?v='+Date.now()),
    fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/main/statuses_cleaned.csv?v='+Date.now())
  ]).then(([ad, sd]) => {
    ad.forEach(a => {
      airports[a.code] = { city: capitalize(a.city), iata: a.iata };  
      if (a.alias) a.alias.split(' ').filter(x=>x).forEach(al => {
        const key = al.toUpperCase(); aliasMap[key] = a.code;
      });
    });
    sd.forEach(s => statuses[s.code.toUpperCase()] = s.description);
  }).catch(e => output.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e);
}
function capitalize(s) { return s ? s.split(/([ -])/).map(w => /^[–ê-–Ø–ÅA-Z]/i.test(w) ? w[0].toUpperCase()+w.slice(1) : w).join('') : ''; }

function matchRoute(tok) {
  for (let len=3; len<=4; len++) {
    const f = tok.slice(0,len), t = tok.slice(len);
    const from = airports[f]?f:(aliasMap[f]||null);
    const to   = airports[t]?t:(aliasMap[t]||null);
    if (from && to) return [from,to];
  }
  return [null,null];
}

function findAirports(tokens) {
  for (const t of tokens) {
    const letters = t.replace(/[^A-Za-z\u0400-\u04FF]/g,'');
    if (letters.length>=6&&letters.length<=8) {
      for (let i=3;i<=letters.length-3;i++) {
        const p1=letters.slice(0,i), p2=letters.slice(i);
        let from=null,to=null;
        if (isCyrillic(p1)) from=aliasMap[p1.toUpperCase()]; else { const k1=p1.toUpperCase(); from=airports[k1]?k1:aliasMap[k1]; }
        if (isCyrillic(p2)) to=aliasMap[p2.toUpperCase()]; else { const k2=p2.toUpperCase(); to=airports[k2]?k2:aliasMap[k2]; }
        if (from&&to) return {from,to};
      }
    }
  }
  for (let i=0;i<tokens.length-1;i++) {
    const a=tokens[i].replace(/[^A-Za-z\u0400-\u04FF]/g,''), b=tokens[i+1].replace(/[^A-Za-z\u0400-\u04FF]/g,'');
    if (!a||!b) continue;
    let from=null,to=null;
    if (isCyrillic(a)) from=aliasMap[a.toUpperCase()]; else { const ka=a.toUpperCase(); from=airports[ka]?ka:aliasMap[ka]; }
    if (isCyrillic(b)) to=aliasMap[b.toUpperCase()]; else { const kb=b.toUpperCase(); to=airports[kb]?kb:aliasMap[kb]; }
    if (from&&to) return {from,to};
  }
  return {};
}

function findFlight(tokens) {
  // –æ–¥–∏–Ω–æ—á–Ω—ã–π token
  for (const t of tokens) {
    const raw=t.replace(/^-/,''), tok=normalizeToken(raw).replace(/[_ ]/g,'-');
    if (statuses[tok]||/^\d{3,4}$/.test(tok)||!/^[A-Z0-9-]+$/.test(tok)) continue;
    const m=tok.match(/^([A-Z0-9]{2})-?(\d{1,4}[A-Z]?)$/i);
    if (m&&/[A-Z]/.test(m[1])) {
      const airline=m[1].toUpperCase(), flight=m[2];
      const parts=raw.split(/[- ]/);
      return { airline,flight, rawAirline:parts[0], rawFlight:parts[1]||parts[0].slice(2) };
    }
  }
  // –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤
  for (let i=0;i<tokens.length-1;i++) {
    const a=tokens[i].replace(/^-/,''), b=tokens[i+1].replace(/^-/,''), an=normalizeToken(a), bn=normalizeToken(b);
    if (!/^[A-Z0-9]{2}$/.test(an)||!/[A-Z]/.test(an)||!/^[0-9]{1,4}[A-Z]?$/.test(bn)) continue;
    return { airline:an,flight:bn, rawAirline:a, rawFlight:b };
  }
  return {};
}

function findDate(tokens) {
  const M={"–Ø–ù–í":"01","–§–ï–í":"02","–ú–ê–†":"03","–ê–ü–†":"04","–ú–ê–ô":"05","–ò–Æ–ù":"06","–ò–Æ–õ":"07","–ê–í–ì":"08","–°–ï–ù":"09","–û–ö–¢":"10","–ù–û–Ø":"11","–î–ï–ö":"12",
           "JAN":"01","FEB":"02","MAR":"03","APR":"04","MAY":"05","JUN":"06","JUL":"07","AUG":"08","SEP":"09","OCT":"10","NOV":"11","DEC":"12"};
  for (const t of tokens) {
    const u=t.toUpperCase().replace(/[.,]/g,'');
    const m=u.match(/^(\d{2})([A-Z–ê-–Ø–Å]{3})(\d{2})?$/);
    if (m) { const[d,mo,yy]=[m[1],m[2],m[3]];
      return{ raw:u, formatted:`${d}.${M[mo]||'??'}.${yy?'20'+yy:'2025'}` };
    }
  }
  return null;
}

function findTimes(tokens,dt) {
  const year=dt?dt.formatted.split('.')[2]:'';
  const arr=tokens.map(t=>t.match(/^(\d{4})$/)).filter(x=>x).map(x=>x[1]).filter(x=>x!==year);
  if(arr.length<2) return {};
  return{ dep:arr[arr.length-2].slice(0,2)+':'+arr[arr.length-2].slice(2), arr:arr[arr.length-1].slice(0,2)+':'+arr[arr.length-1].slice(2) };
}

function findStatus(tokens) {for(const t of tokens) if(statuses[t.toUpperCase()]) return statuses[t.toUpperCase()]; return '';}

function preprocessGDS(l) {
  return l.replace(/[.,#]/g,'').replace(/\s+O\*/g,'').replace(/\s+E\b/g,'')
          .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g,'$1-$2');
}

function decode() {
  const lines=preprocessGDS(input.value.trim()).split(/\n+/), out=[];
  for(const line of lines) {
    const tokens=line.trim().split(/\s+/).filter(x=>x&&!/^[.,*]$/.test(x));
    const fl=findFlight(tokens), dt=findDate(tokens), tm=findTimes(tokens,dt), ap=findAirports(tokens), st=findStatus(tokens);
    if(fl.airline&&fl.flight&&ap.from&&ap.to&&tm.dep&&tm.arr) {
      const A=airports[ap.from], B=airports[ap.to];
      let r=`${fl.rawAirline}-${fl.rawFlight}`;
      if(dt) r+=` ${dt.formatted}`;
      r+= dt?', ':' ';
      r+=`${A.city} ${A.iata} ${tm.dep} ‚Äî ${B.city} ${B.iata} ${tm.arr}`;
      if(st) r+=` ‚Äî ${st}`;
      out.push(r);
    } else out.push(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: ${line}`);
  }
  output.textContent=out.join('\n');
}

function copyResult(){navigator.clipboard.writeText(output.textContent);}function clearAll(){input.value='';output.textContent='';}

init();
</script>
</body>
</html>
