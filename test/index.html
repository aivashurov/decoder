<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</title>
  <style>
    body.dark-mode { background:#121212; color:#eee }
    body.dark-mode textarea, body.dark-mode pre { background:#1e1e1e; color:#fff; border:1px solid #444 }
    body.dark-mode button { background:#2c2c2c; color:#eee; border:1px solid #555 }
    .dark-toggle {
      position:absolute; top:10px; right:10px;
      padding:6px 12px; background:#333; color:#eee; border:1px solid #666; border-radius:6px; cursor:pointer;
      z-index:1000;
    }
    body.transition, body.transition * { transition: background-color .3s, color .3s, border-color .3s }
    body { font-family:sans-serif; padding:20px; max-width:900px; margin:auto }
    textarea { width:100%; height:120px; font-family:monospace; font-size:14px }
    button { margin:5px 5px 0 0; padding:8px 16px; font-size:14px }
    pre { background:#f0f0f0; padding:10px; white-space:pre-wrap; border:1px solid #ccc }
    pre#extended-output { margin-top:10px; background:#f9f9f9 }
  </style>
</head>
<body>
  <button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea><br>
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>
  <pre id="extended-output">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π.</pre>

  <script>
  //‚Äî‚Äî Dark Mode ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function toggleDarkMode(){
    document.body.classList.add('transition');
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark?'dark':'light');
    document.getElementById('theme-toggle').textContent = isDark?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
    setTimeout(()=>document.body.classList.remove('transition'), 300);
  }
  window.addEventListener('DOMContentLoaded', ()=>{
    const dark = localStorage.getItem('theme')==='dark';
    if(dark) document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').textContent = dark?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
  });

  //‚Äî‚Äî –î–∞–Ω–Ω—ã–µ (CSV) ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  let airports={}, aliasMap={}, statuses={};
  function fetchCSV(url){
    return fetch(url).then(r=>r.text()).then(txt=>{
      const [hdr,...rows] = txt.trim().split(/\r?\n/);
      const keys = hdr.split(',').map(k=>k.trim());
      return rows.map(r=> {
        const vals=r.split(',');
        const obj={};
        keys.forEach((k,i)=>obj[k]=vals[i]?.trim()||"");
        return obj;
      });
    });
  }
  function init(){
    Promise.all([
      fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv'),
      fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv')
    ]).then(([ap,st])=>{
      ap.forEach(a=>{
        airports[a.code] = { city: capitalize(a.city), iata: a.iata };
        if(a.alias){
          a.alias.split(' ').filter(x=>x).forEach(alias=>{
            const norm = isCyrillic(alias)? normalizeCyrillic(alias): alias;
            aliasMap[norm.toUpperCase()] = a.code;
          });
        }
      });
      st.forEach(s=>statuses[s.code.toUpperCase()] = s.description);
    }).catch(e=>{
      document.getElementById('output').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: '+e;
    });
  }
  function isCyrillic(s){ return /[–ê-–Ø–Å–∞-—è—ë]/.test(s); }
  function normalizeCyrillic(s){
    return s.replace(/C/g,'–°').replace(/A/g,'–ê').replace(/E/g,'–ï')
            .replace(/O/g,'–û').replace(/K/g,'–ö').replace(/M/g,'–ú')
            .replace(/H/g,'–ù').replace(/X/g,'–•');
  }
  function capitalize(s){
    return s? s.split(/([ -])/g).map(w=>
      /[–ê-–Ø–ÅA-Z]/i.test(w[0])? w[0].toUpperCase()+w.slice(1):w
    ).join('') : '';
  }

  //‚Äî‚Äî –£—Ç–∏–ª–∏—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function preprocessGDS(line){
    return line
      .replace(/^\s*\d+\s*\.\s*/, '')   // —É–±–∏—Ä–∞–µ–º "1 .", "2."
      .replace(/[.,#\/]/g,'')           // .,/#,/
      .replace(/\s+O\*/g,'')            // O*
      .replace(/\s+E\b/g,'')            // lone E
      .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g,'$1-$2'); // SU6321‚ÜíSU-6321
  }
  function extractDays(line){
    const dm={MO:'–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',TU:'–≤—Ç–æ—Ä–Ω–∏–∫',WE:'—Å—Ä–µ–¥–∞',TH:'—á–µ—Ç–≤–µ—Ä–≥',FR:'–ø—è—Ç–Ω–∏—Ü–∞',SA:'—Å—É–±–±–æ—Ç–∞',SU:'–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'};
    const m=line.match(/\b(MO|TU|WE|TH|FR|SA|SU)(\/(MO|TU|WE|TH|FR|SA|SU))*\b/g);
    return m? m[0].split('/').map(d=>dm[d]||d).join(', '):'';
  }
  function matchRoute(rt){
    for(let len=3;len<=4;len++){
      const f=rt.slice(0,len), t=rt.slice(len);
      const fm=aliasMap[f]|| (airports[f]?f:null),
            tm=aliasMap[t]|| (airports[t]?t:null);
      if(fm&&tm) return [fm,tm];
    }
    return [null,null];
  }

  //‚Äî‚Äî –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function decode(){
    const raw = document.getElementById('input').value||'';
    const text = preprocessGDS(raw);
    const lines = text.split(/\n+/);
    const mainOut = [], extOut = [];

    for(const rawLine of lines){
      const line = rawLine.trim();
      if(!line) continue;

      // 1) –ò–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç—É—Å –î–û –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
      const statusMatch = line.match(/\b([A-Z]{2}\d)\b/);
      const statusCode = statusMatch? statusMatch[1].toUpperCase() : '';
      const statusDesc = statuses[statusCode] || '';

      // 2) GDS-—Å–ª—É–∂–±–∞
      const svc = line.match(/^(SSR|FLIFO|OSI)\s+(.*)$/i);
      if(svc){
        extOut.push(`üí¨ –°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ [${svc[1].toUpperCase()}]: ${svc[2]}`);
        mainOut.push(line + (statusDesc? ' ‚Äî '+statusDesc:''));
        continue;
      }

      // 3) –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º—É—Å–æ—Ä–∞
      let tokens = line.toUpperCase().split(/\s+/);
      const junk = ['*','.','/',',','#'];
      tokens = tokens.filter(t=> !/^[0-9]$/.test(t) && !junk.includes(t));

      // 4) airline/flight
      let airline='', flight='';
      for(let i=0;i<tokens.length-1;i++){
        if(/^[A-Z0-9]{2}$/.test(tokens[i]) && /^[0-9]{2,4}[A-Z]?$/.test(tokens[i+1])){
          airline=tokens[i]; flight=tokens[i+1]; break;
        }
      }
      if(!airline && /^[A-Z0-9]{2}-\d{2,4}$/.test(tokens[0])){
        [airline,flight] = tokens[0].split('-');
      }

      // 5) –î–∞—Ç–∞
      let dateToken = tokens.find(t=>/^\d{2}[A-Z–ê-–Ø–Å]{3}(\d{2})?$/.test(t))||'';
      let formattedDate='‚ö†Ô∏è';
      if(dateToken){
        const d=dateToken.slice(0,2),
              m=dateToken.slice(2,5).toUpperCase(),
              y=dateToken.length===7?('20'+dateToken.slice(5)):new Date().getFullYear();
        const mm = {'–Ø–ù–í':'01','–§–ï–í':'02','–ú–ê–†':'03','–ê–ü–†':'04','–ú–ê–ô':'05','–ò–Æ–ù':'06',
                    '–ò–Æ–õ':'07','–ê–í–ì':'08','–°–ï–ù':'09','–û–ö–¢':'10','–ù–û–Ø':'11','–î–ï–ö':'12',
                    'JAN':'01','FEB':'02','MAR':'03','APR':'04','MAY':'05','JUN':'06',
                    'JUL':'07','AUG':'08','SEP':'09','OCT':'10','NOV':'11','DEC':'12'}[m]||'??';
        formattedDate=`${d}.${mm}.${y}`;
      }

      // 6) –ú–∞—Ä—à—Ä—É—Ç
      let routeToken = tokens.find(t=>/^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t))||'';
      if(!routeToken){
        const idx = tokens.findIndex((t,i)=>aliasMap[t]&&tokens[i+1]);
        if(idx>=0) routeToken = tokens[idx]+tokens[idx+1];
      }
      // –æ—Ç—Ü–µ–ø–∏—Ç—å —Å–∫–ª–µ–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      for(let sc in statuses){
        if(routeToken.endsWith(sc)){
          const pr = routeToken.slice(0,-sc.length);
          const f = pr.slice(0,3), t = pr.slice(3);
          if((aliasMap[f]||airports[f])&&(aliasMap[t]||airports[t])){
            tokens = tokens.map(x=>x===routeToken?pr:x);
            tokens.push(sc);
            routeToken = pr;
            break;
          }
        }
      }
      const [fromCode,toCode] = matchRoute(isCyrillic(routeToken)?normalizeCyrillic(routeToken):routeToken);
      const from = airports[fromCode], to = airports[toCode];

      // 7) –í—Ä–µ–º—è
      const times = tokens.map(t=>t.match(/^\d{4}$/)?t:null).filter(Boolean);
      let dep = times[times.length-2]||'', arr = times[times.length-1]||'';
      if(dep.length===4) dep = dep.slice(0,2)+':'+dep.slice(2);
      if(arr.length===4) arr = arr.slice(0,2)+':'+arr.slice(2);

      // 8) –°–æ–±–∏—Ä–∞–µ–º –≤—ã–≤–æ–¥
      if(airline && flight && from && to && dep && arr && formattedDate){
        let lineOut = `${airline}-${flight} ${formattedDate}, ${from.city} ${from.iata} ${dep} ‚Äî ${to.city} ${to.iata} ${arr}`;
        if(statusDesc) lineOut += ` ‚Äî ${statusDesc}`;
        mainOut.push(lineOut);

        extOut.push(
          `–ò—Å—Ö.: ${line}`,
          ` ‚Üí –∫–æ–¥ —Å—Ç–∞—Ç—É—Å–∞: ${statusCode||'<–Ω–µ—Ç>'}`,
          ` ‚Üí —Å—Ç–∞—Ç—É—Å: ${statusDesc||'<–Ω–µ—Ç>'}`,
          ` ‚Üí –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è: ${airline}`,
          ` ‚Üí —Ä–µ–π—Å: ${flight}`,
          ` ‚Üí –¥–∞—Ç–∞: ${formattedDate}`,
          ` ‚Üí –º–∞—Ä—à—Ä—É—Ç: ${from.city}‚Üí${to.city}`,
          ` ‚Üí –≤—Ä–µ–º—è: ${dep}‚Üí${arr}`,
          ''
        );
      } else {
        mainOut.push(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å: ${line}`);
        extOut.push(`‚ùå –ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${line}\n`);
      }
    }

    document.getElementById('output').textContent = mainOut.join('\n');
    document.getElementById('extended-output').textContent = extOut.join('\n');
  }

  function copyResult(){
    navigator.clipboard.writeText(document.getElementById('output').textContent);
  }
  function clearAll(){
    document.getElementById('input').value='';
    document.getElementById('output').textContent='';
    document.getElementById('extended-output').textContent='–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π.';
  }

  init();
  </script>
</body>
</html>
