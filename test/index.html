<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</title>

  <style>
  /* ================== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ================== */
  body.dark-mode { background-color: #121212; color: #eee; }
  body.dark-mode input,
  body.dark-mode textarea,
  body.dark-mode pre#output,
  body.dark-mode pre#extended-output {
    background-color: #1e1e1e; color: #fff; border: 1px solid #444;
  }
  body.dark-mode button { background-color: #2c2c2c; color: #eee; border: 1px solid #555; }

  body.transition, body.transition * {
    transition: background-color .3s ease, color .3s ease, border-color .3s ease;
  }

  .dark-toggle {
    position: absolute; top: 10px; right: 10px;
    font-size: 14px; cursor: pointer; padding: 6px 12px; border-radius: 6px;
    background: #333; color: #eee; border: 1px solid #666; z-index: 1000;
  }
  /* ============== –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨ ============== */
  body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
  textarea { width: 100%; height: 150px; font-family: monospace; font-size: 14px; }
  button { padding: 10px 20px; font-size: 14px; margin-top:10px; margin-right:10px; }
  pre#output { background: #f0f0f0; padding:15px; white-space: pre-wrap; border:1px solid #ccc; }
  /* ============= EXTENDED OUTPUT ============= */
  pre#extended-output {
    background: #f9f9f9; padding:15px; white-space: pre-wrap;
    border:1px solid #ccc; margin-top:10px; font-family: monospace; font-size:14px;
  }
  </style>

</head>
<body>

  <button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">
    üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
  </button>

  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea><br/>
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>

  <pre id="output"></pre>
  <pre id="extended-output">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π.</pre>

<script>
// ====== –¢–ï–ú–ê ======
function toggleDarkMode(){
  document.body.classList.add('transition');
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('theme', isDark?'dark':'light');
  updateToggleIcon(isDark);
  setTimeout(()=>document.body.classList.remove('transition'),300);
}
function updateToggleIcon(isDark){
  document.getElementById('theme-toggle').innerHTML = 
    isDark?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
}
window.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem('theme');
  const dark = saved==='dark';
  if(dark) document.body.classList.add('dark-mode');
  updateToggleIcon(dark);
});

// ====== –î–ê–ù–ù–´–ï ======
let airports={}, aliasMap={}, statuses={};

function isCyrillic(str){ return /[–ê-–Ø–Å–∞-—è—ë]/.test(str); }
function normalizeCyrillic(str){
  return str.replace(/C/g,'–°').replace(/A/g,'–ê')
            .replace(/E/g,'–ï').replace(/O/g,'–û')
            .replace(/K/g,'–ö').replace(/M/g,'–ú')
            .replace(/H/g,'–ù').replace(/X/g,'–•');
}

// –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CSV —Å GitHub
function fetchCSV(url){
  return fetch(url).then(r=>r.text()).then(txt=>{
    const [hdr,...rows]=txt.trim().split(/\r?\n/);
    const keys = hdr.split(',');
    return rows.map(r=> {
      const vals=r.split(',');
      const obj={};
      keys.forEach((k,i)=>obj[k.trim()]=vals[i]?.trim()||"");
      return obj;
    });
  });
}

function init(){
  Promise.all([
    fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv"),
    fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv")
  ])
  .then(([ap,st])=>{
    ap.forEach(a=>{
      airports[a.code] = { city: capitalize(a.city), iata: a.iata };
      if(a.alias){
        a.alias.split(' ').filter(x=>x).forEach(alias=>{
          const norm = isCyrillic(alias)?normalizeCyrillic(alias):alias;
          aliasMap[norm.toUpperCase()] = a.code;
        });
      }
    });
    st.forEach(s=>statuses[s.code.toUpperCase()]=s.description);
  })
  .catch(e=>document.getElementById("output").textContent="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: "+e);
}

function capitalize(str){
  return str?str.split(/([ -])/g)
    .map(w=>/[–ê-–Ø–ÅA-Z]/i.test(w[0])? w[0].toUpperCase()+w.slice(1):w)
    .join(''):"";
}

// –ò—â–µ–º –∫–æ–¥ –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ (3 –∏–ª–∏ 4 –±—É–∫–≤—ã)
function matchRoute(rt){
  for(let len=3;len<=4;len++){
    const f=rt.slice(0,len), t=rt.slice(len);
    const fm=aliasMap[f]||((airports[f]?f:null)),
          tm=aliasMap[t]||((airports[t]?t:null));
    if(fm&&tm) return [fm,tm];
  }
  return [null,null];
}

// –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞: —É–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç—ã–µ, #, O*, –æ–¥–∏–Ω–æ—á–Ω–æ–µ E, —Å–∫–ª–µ–∏–≤–∞–µ–º SU6321‚ÜíSU-6321
function preprocessGDS(line){
  return line.replace(/[.,#]/g,'')
             .replace(/\s+O\*/g,'')
             .replace(/\s+E\b/g,'')
             .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g,'$1-$2');
}

// –í—ã—Ç–∞—â–∏—Ç—å –¥–Ω–∏ –ø–æ–ª—ë—Ç–∞ (MO/TU/‚Ä¶)
function extractDays(line){
  const dm={MO:"–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",TU:"–≤—Ç–æ—Ä–Ω–∏–∫",WE:"—Å—Ä–µ–¥–∞",TH:"—á–µ—Ç–≤–µ—Ä–≥",FR:"–ø—è—Ç–Ω–∏—Ü–∞",SA:"—Å—É–±–±–æ—Ç–∞",SU:"–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"};
  const m=line.match(/\b(MO|TU|WE|TH|FR|SA|SU)(\/(MO|TU|WE|TH|FR|SA|SU))*\b/g);
  return m?m[0].split('/').map(d=>dm[d]||d).join(', '):"";
}

// ====== –û–°–ù–û–í–ù–û–ô –ü–ê–†–°–ï–† ======
function decode(){
  const text = preprocessGDS(document.getElementById("input").value || "");
  const lines = text.split(/\n+/);
  const main = [], ext = [];

  for(const raw of lines){
    const line = raw.trim();
    if(!line) continue;

    // 1) –°–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è GDS
    const svc = line.match(/^(SSR|FLIFO|OSI)\s+(.*)$/i);
    if(svc){
      const type = svc[1].toUpperCase(), content=svc[2];
      ext.push(`üí¨ –°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ [${type}]: ${content}`);
      main.push(line); 
      continue;
    }

    // 2) –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —Ç–æ–∫–µ–Ω—ã, —É–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä
    let tokens = line.toUpperCase().split(/\s+/);
    const junk = ["*",".",","];
    tokens = tokens.filter(t=>!/^\d$/.test(t)&&!junk.includes(t));

    // 3) –ò—â–µ–º airline-—Ñ–ª–∞–π—Ç
    let airline="", flight="";
    for(let i=0;i<tokens.length-1;i++){
      if(/^[A-Z0-9]{2}$/.test(tokens[i])&&/^[0-9]{2,4}[A-Z]?$/.test(tokens[i+1])){
        airline=tokens[i]; flight=tokens[i+1]; break;
      }
    }
    if(!airline && /^[A-Z0-9]{2}-\d{2,4}$/.test(tokens[0])){
      [airline,flight]=tokens[0].split("-");
    }

    // 4) –î–∞—Ç–∞
    let dateToken = tokens.find(t=>/^\d{2}[A-Z–ê-–Ø–Å]{3}(\d{2})?$/.test(t))||"";
    const months={–Ø–ù–í:"01",–§–ï–í:"02",–ú–ê–†:"03",–ê–ü–†:"04",–ú–ê–ô:"05",–ò–Æ–ù:"06",
      –ò–Æ–õ:"07",–ê–í–ì:"08",–°–ï–ù:"09",–û–ö–¢:"10",–ù–û–Ø:"11",–î–ï–ö:"12",
      JAN:"01",FEB:"02",MAR:"03",APR:"04",MAY:"05",JUN:"06",JUL:"07",AUG:"08",SEP:"09",OCT:"10",NOV:"11",DEC:"12"};
    let formattedDate="‚ö†Ô∏è";
    if(dateToken){
      const d=dateToken.slice(0,2),
            m=months[dateToken.slice(2,5).toUpperCase()]||"??",
            y=dateToken.length===7?("20"+dateToken.slice(5)):new Date().getFullYear();
      formattedDate=`${d}.${m}.${y}`;
    }

    // 5) –ú–∞—Ä—à—Ä—É—Ç
    let routeToken = tokens.find(t=>/^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t))||"";
    if(!routeToken){
      const idx=tokens.findIndex((t,i)=>aliasMap[t]&&aliasMap[tokens[i+1]]);
      if(idx>=0) routeToken=tokens[idx]+tokens[idx+1];
    }
    // status –ø—Ä–∏–∫–ª–µ–µ–Ω–Ω—ã–π –∫ –º–∞—Ä—à—Ä—É—Ç—É
    for(let sc in statuses){
      if(routeToken.endsWith(sc)){
        const pr=routeToken.slice(0,-sc.length),
              f=pr.slice(0,3), t=pr.slice(3);
        if((aliasMap[f]||airports[f])&&(aliasMap[t]||airports[t])){
          tokens=tokens.map(x=>x===routeToken?pr:x);
          tokens.push(sc);
          routeToken=pr;
          break;
        }
      }
    }

    const [fromCode,toCode] = matchRoute(isCyrillic(routeToken)?normalizeCyrillic(routeToken):routeToken);
    const from = airports[fromCode], to = airports[toCode];

    // 6) –°—Ç–∞—Ç—É—Å
    const statusToken = tokens.slice(2).find(t=>statuses[t]);
    const status = statuses[statusToken]||"";

    // 7) –í—Ä–µ–º—è
    const times = tokens.map(t=>t.match(/^\d{4}$/)?t:null).filter(Boolean);
    let dep=times[times.length-2]||"", arr=times[times.length-1]||"";
    if(dep.length===4) dep=dep.slice(0,2)+":"+dep.slice(2);
    if(arr.length===4) arr=arr.slice(0,2)+":"+arr.slice(2);

    // 8) –°–±–æ—Ä–∫–∞ –≤—ã–≤–æ–¥–∞
    if(airline&&flight&&from&&to&&dep&&arr&&formattedDate){
      // –æ—Å–Ω–æ–≤–Ω–æ–π
      main.push(`${airline}-${flight} ${formattedDate}, ${from.city} ${from.iata} ${dep} ‚Äî ${to.city} ${to.iata} ${arr}${status?" ‚Äî "+status:""}`);
      // extended
      ext.push(
        `–ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: ${line}`,
        ` ‚Üí –ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è: ${airline}`,
        ` ‚Üí –†–µ–π—Å: ${flight}`,
        ` ‚Üí –î–∞—Ç–∞: ${formattedDate}`,
        ` ‚Üí –ú–∞—Ä—à—Ä—É—Ç: ${from.city}‚Üí${to.city}`,
        ` ‚Üí –í—Ä–µ–º—è: ${dep}‚Üí${arr}`,
        ` ‚Üí –°—Ç–∞—Ç—É—Å: ${status||"–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"}\n`
      );
    } else {
      main.push(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: ${line}`);
      ext.push(`‚ùå –ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${line}\n`);
    }
  }

  document.getElementById("output").textContent = main.join("\n");
  document.getElementById("extended-output").textContent = ext.join("\n");
}

// ====== –ö–ù–û–ü–ö–ò ======
function copyResult(){
  navigator.clipboard.writeText(document.getElementById("output").textContent);
}
function clearAll(){
  document.getElementById("input").value="";
  document.getElementById("output").textContent="";
  document.getElementById("extended-output").textContent="–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π.";
}

init();
</script>
</body>
</html>
