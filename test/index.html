<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç–æ–≤—ã–π –¥–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å GDS‚Äë–ø–∞—Ä—Å–µ—Ä–∞–º–∏</title>
  <style>
    body { font-family: sans-serif; padding:20px; max-width:900px; margin:auto }
    textarea { width:100%; height:150px; font-family:monospace; font-size:14px }
    button { margin:5px; padding:8px 16px; font-size:14px }
    pre { background:#f0f0f0; padding:10px; white-space:pre-wrap; border:1px solid #ccc }
    /* —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    body.dark-mode { background:#121212; color:#eee }
    body.dark-mode textarea, body.dark-mode pre#output {
      background:#1e1e1e; color:#fff; border:1px solid #444
    }
    body.dark-mode button { background:#2c2c2c; color:#eee; border:1px solid #555 }
    .dark-toggle {
      position:absolute; top:10px; right:10px; padding:6px 12px;
      background:#333; color:#eee; border:1px solid #666; border-radius:6px; cursor:pointer;
    }
    body.transition, body.transition * {
      transition: background-color .3s, color .3s, border-color .3s;
    }
  </style>
</head>
<body>
  <button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">
    üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (—Ç–µ—Å—Ç)
  </button>
  <script>
    function toggleDarkMode() {
      document.body.classList.add('transition');
      const d = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', d?'dark':'light');
      document.getElementById('theme-toggle').textContent = d?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (—Ç–µ—Å—Ç)':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (—Ç–µ—Å—Ç)';
      setTimeout(()=>document.body.classList.remove('transition'),300);
    }
    window.addEventListener('DOMContentLoaded',()=>{
      const dark = localStorage.getItem('theme')==='dark';
      if(dark) document.body.classList.add('dark-mode');
      document.getElementById('theme-toggle').textContent =
        dark?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (—Ç–µ—Å—Ç)':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (—Ç–µ—Å—Ç)';
    });
  </script>

  <h2>–¢–µ—Å—Ç–æ–≤—ã–π –¥–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å GDS‚Äë–ø–∞—Ä—Å–µ—Ä–∞–º–∏</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)‚Ä¶"></textarea><br>
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>

<script>
let airports={}, aliasMap={}, statuses={};

// ‚Äî‚Äî‚Äî –£—Ç–∏–ª–∏—Ç—ã ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function isCyrillic(s){ return /[–ê-–Ø–Å–∞-—è—ë]/.test(s); }
function normalizeCyrillic(s){
  return s.replace(/C/g,'–°').replace(/A/g,'–ê').replace(/E/g,'–ï')
          .replace(/O/g,'–û').replace(/K/g,'–ö')
          .replace(/M/g,'–ú').replace(/H/g,'–ù')
          .replace(/X/g,'–•');
}
function capitalize(s){
  return s? s.split(/([ -])/g).map(w=>
    /[–ê-–Ø–ÅA-Z]/i.test(w[0])? w[0].toUpperCase()+w.slice(1): w
  ).join('') : '';
}

// ‚Äî‚Äî‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ CSV –∏–∑ GitHub ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function fetchCSV(url){
  return fetch(url).then(r=>r.text()).then(txt=>{
    const [hdr,...rows] = txt.trim().split(/\r?\n/);
    const keys = hdr.split(',').map(x=>x.trim());
    return rows.map(r=>{
      const vals = r.split(',');
      const o = {};
      keys.forEach((k,i)=> o[k]= (vals[i]||"").trim() );
      return o;
    });
  });
}

function init(){
  Promise.all([
    fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv'),
    fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv')
  ]).then(([aps,sts])=>{
    aps.forEach(a=>{
      airports[a.code] = { city: capitalize(a.city), iata: a.iata };
      if(a.alias){
        a.alias.split(' ').filter(x=>x).forEach(alias=>{
          const norm = isCyrillic(alias)? normalizeCyrillic(alias): alias;
          aliasMap[norm.toUpperCase()] = a.code;
        });
      }
    });
    // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
    sts.forEach(s=>{
      if(s && s.code){
        statuses[s.code.trim().toUpperCase()] = (s.description||"").trim();
      }
    });
  }).catch(e=>{
    document.getElementById('output').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e;
  });
}

// ‚Äî‚Äî‚Äî –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function matchRoute(rt){
  for(let L=3;L<=4;L++){
    const f=rt.slice(0,L), t=rt.slice(L);
    const fm= aliasMap[f]|| (airports[f]?f:null);
    const tm= aliasMap[t]|| (airports[t]?t:null);
    if(fm && tm) return [fm,tm];
  }
  return [null,null];
}

// ‚Äî‚Äî‚Äî GDS‚Äë–ø–∞—Ä—Å–µ—Ä—ã ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function genericClean(line){
  return line
    .replace(/^\s*\d+(?:[.\)]\s+|\s+)/,'')   // —É–±—Ä–∞—Ç—å –ª–∏–¥–∏—Ä—É—é—â—É—é –Ω—É–º–µ—Ä–∞—Ü–∏—é
    .replace(/[.,#\/]/g,'')                  // —É–¥–∞–ª–∏—Ç—å . , # /
    .replace(/\s+O\*/g,'')                   // —É–±—Ä–∞—Ç—å O*
    .replace(/\s+E\b/g,'')                   // —É–±—Ä–∞—Ç—å –æ–¥–∏–Ω–æ—á–Ω–æ–µ E
    .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g,'$1-$2');
}

// Sirena: –æ–±—ã—á–Ω–æ HS1/HS2 + –∫–∏—Ä. –∑–∞–º–µ–Ω—ã
function sirenaClean(line){
  // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü‚Äë–ø—Ä–∞–≤–∏–ª–∞ Sirena
  return genericClean(line).replace(/HS(\d)/g,'HS$1');
}

// Sabre: —É–±–∏—Ä–∞–µ–º —Å–ª—ç—à–∏ –º–µ–∂–¥—É –∫–æ–¥–∞–º–∏
function sabreClean(line){
  return genericClean(line).replace(/([A-Z]{3})\/([A-Z]{3})/g,'$1$2');
}

// Galileo: —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Å–∏–º–≤–æ–ª—ã `*` –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
function galileoClean(line){
  return genericClean(line).replace(/\*/g,'');
}

// Amadeus: –º–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ç–∏–ø–∞ `@A` –∏–ª–∏ `@B`
function amadeusClean(line){
  return genericClean(line).replace(/@[A-Z]/g,'');
}

const gdsCleaners = {
  sirena: sirenaClean,
  sabre:  sabreClean,
  galileo:galileoClean,
  amadeus:amadeusClean,
  default:genericClean
};

// –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º –º–∞—Ä–∫–µ—Ä–∞–º
function detectGDS(line){
  if(/HS[12]/.test(line))           return 'sirena';
  if(/\b[A-Z]{3}\/[A-Z]{3}\b/.test(line)) return 'sabre';
  if(/\*/.test(line))               return 'galileo';
  if(/@/.test(line))                return 'amadeus';
  return 'default';
}

function preprocessGDS(line){
  const prof = detectGDS(line);
  return gdsCleaners[prof](line);
}

// –¥–Ω–µ–π –ø–æ–ª—ë—Ç–∞ –Ω–∞ —Ç–µ—Å—Ç–µ –Ω–µ –≤—ã–≤–æ–¥–∏–º
function extractDays(line){ return ''; }

// ‚Äî‚Äî‚Äî –û—Å–Ω–æ–≤–Ω–æ–π decode() ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function decode(){
  const raw = document.getElementById('input').value||'';
  const text = preprocessGDS(raw);
  const lines = text.split(/\n+/);
  const out=[];

  for(const rawLine of lines){
    const L = rawLine.trim();
    if(!L) continue;

    let tokens = L.toUpperCase().split(/\s+/)
      .filter(t=> !/^[0-9]$/.test(t) && !/^[\*\.\,\/#]$/.test(t));

    // airline+flight
    const cleaned = tokens.filter(t=> 
      !/^\d{1,2}$/.test(t) &&
      !["*",".","O","E","SU","MO","TU","WE","TH","FR","SA",
        "–±–µ–∑","–∏–∑–º–µ–Ω–µ–Ω–∏–π","–æ—Ç–º–µ–Ω—ë–Ω","–ø—Ä–µ–¥–ª–æ–∂–µ–Ω","–∏–∑–º–µ–Ω–µ–Ω–∏–µ"].includes(t)
    );
    let airline='', flight='';
    for(let i=0;i<cleaned.length-1;i++){
      if(/^[A-Z0-9]{2}$/.test(cleaned[i]) &&
         /^[0-9]{2,4}[A-Z]?$/.test(cleaned[i+1])){
        airline=cleaned[i]; flight=cleaned[i+1]; break;
      }
    }
    if(!airline && /^[A-Z0-9]{2}-\d{2,4}$/.test(cleaned[0])){
      [airline,flight] = cleaned[0].split('-');
    }

    // date
    const dtok = tokens.find(t=> /^\d{2}[A-Z–ê-–Ø–Å]{3}(?:\d{2})?$/.test(t))||'';
    const mon = {
      "–Ø–ù–í":"01","–§–ï–í":"02","–ú–ê–†":"03","–ê–ü–†":"04","–ú–ê–ô":"05","–ò–Æ–ù":"06",
      "–ò–Æ–õ":"07","–ê–í–ì":"08","–°–ï–ù":"09","–û–ö–¢":"10","–ù–û–Ø":"11","–î–ï–ö":"12",
      "JAN":"01","FEB":"02","MAR":"03","APR":"04","MAY":"05","JUN":"06",
      "JUL":"07","AUG":"08","SEP":"09","OCT":"10","NOV":"11","DEC":"12"
    }[dtok.slice(2,5).toUpperCase()]||'??';
    let formattedDate = dtok? `${dtok.slice(0,2)}.${mon}.${dtok.length===7?('20'+dtok.slice(5)):new Date().getFullYear()}` : '‚ö†Ô∏è';

    // –º–∞—Ä—à—Ä—É—Ç + –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    let routeToken = tokens.find(t=>/^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t))||'';
    if(!routeToken){
      const idx = tokens.findIndex((t,i)=> aliasMap[t] && tokens[i+1]);
      if(idx>=0) routeToken = tokens[idx]+tokens[idx+1];
    }
    for(let sc in statuses){
      if(routeToken.endsWith(sc)){
        const pure = routeToken.slice(0,-sc.length);
        tokens = tokens.map(t=> t===routeToken? pure : t);
        tokens.push(sc);
        routeToken = pure;
        break;
      }
    }
    const [fromCode,toCode] = matchRoute(isCyrillic(routeToken)? normalizeCyrillic(routeToken):routeToken);
    const from = airports[fromCode], to = airports[toCode];

    // –≤—Ä–µ–º–µ–Ω–∞
    const times = tokens.map(t=> t.match(/^\d{4}$/)?t:null).filter(Boolean);
    let dep=times[times.length-2]||'', arr=times[times.length-1]||'';
    if(dep.length===4) dep=dep.slice(0,2)+':'+dep.slice(2);
    if(arr.length===4) arr=arr.slice(0,2)+':'+arr.slice(2);

    // —Å—Ç–∞—Ç—É—Å
    const statusToken = tokens.find(t=> statuses[t]);
    const status = statuses[statusToken]||'';

    if(airline&&flight&&from&&to&&dep&&arr&&formattedDate){
      out.push(`${airline}-${flight} ${formattedDate}, `
        +`${from.city} ${from.iata} ${dep} ‚Äî `
        +`${to.city} ${to.iata} ${arr}`
        +`${status? ' ‚Äî '+status : ''}`
      );
    } else {
      out.push("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: "+L);
    }
  }

  document.getElementById('output').textContent = out.join('\n');
}

function copyResult(){ navigator.clipboard.writeText(document.getElementById('output').textContent); }
function clearAll(){
  document.getElementById('input').value=''; document.getElementById('output').textContent='';
}

init();
</script>
</body>
</html>
