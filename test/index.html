<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–æ–∫</title>
  <style>
    /* ‚Äî‚Äî‚Äî –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Äî‚Äî‚Äî */
    body.dark-mode { background-color: #121212; color: #eee; }
    body.dark-mode textarea,
    body.dark-mode pre#output {
      background-color: #1e1e1e;
      color: #fff;
      border: 1px solid #444;
    }
    body.dark-mode button {
      background-color: #2c2c2c;
      color: #eee;
      border: 1px solid #555;
    }
    body.transition, body.transition * {
      transition: background-color 0.3s ease,
                  color 0.3s ease,
                  border-color 0.3s ease;
    }
    .dark-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 14px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      background: #333;
      color: #eee;
      border: 1px solid #666;
      z-index: 1000;
    }
    /* ‚Äî‚Äî‚Äî –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ ‚Äî‚Äî‚Äî */
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 150px; font-family: monospace; font-size: 14px; }
    button { padding: 10px 20px; font-size: 14px; margin-top: 10px; margin-right: 10px; }
    pre { background: #f0f0f0; padding: 15px; white-space: pre-wrap; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">
    üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
  </button>

  <script>
    function toggleDarkMode() {
      document.body.classList.add('transition');
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateToggleIcon(isDark);
      setTimeout(() => document.body.classList.remove('transition'), 300);
    }
    function updateToggleIcon(isDark) {
      const btn = document.getElementById('theme-toggle');
      btn.innerHTML = isDark ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
    }
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('theme');
      const isDark = saved === 'dark';
      if (isDark) document.body.classList.add('dark-mode');
      updateToggleIcon(isDark);
    });
  </script>

  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea><br />
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>

  <script>
    let airports = {};
    let aliasMap = {};
    let statuses = {};

    function isCyrillic(str) {
      return /[–ê-–Ø–Å–∞-—è—ë]/.test(str);
    }
    function normalizeCyrillic(str) {
      return str
        .replace(/C/g, "–°")
        .replace(/A/g, "–ê")
        .replace(/E/g, "–ï")
        .replace(/O/g, "–û")
        .replace(/K/g, "–ö")
        .replace(/M/g, "–ú")
        .replace(/H/g, "–ù")
        .replace(/X/g, "–•");
    }
    function fetchCSV(url) {
      return fetch(url)
        .then(r => r.text())
        .then(text => {
          const [hdr, ...rows] = text.trim().split(/\r?\n/);
          const keys = hdr.split(',').map(k => k.trim());
          return rows.map(r => {
            const vals = r.split(',');
            const obj = {};
            keys.forEach((k, i) => obj[k] = vals[i] ? vals[i].trim() : "");
            return obj;
          });
        });
    }
    function init() {
      Promise.all([
        fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv?v=" + Date.now()),
        fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv?v=" + Date.now())
      ]).then(([apD, stD]) => {
        apD.forEach(a => {
          airports[a.code] = { city: capitalize(a.city), iata: a.iata };
          if (a.alias) {
            a.alias.split(' ')
              .map(x => x.trim()).filter(x => x)
              .forEach(alias => {
                const norm = isCyrillic(alias) ? normalizeCyrillic(alias) : alias;
                aliasMap[norm.toUpperCase()] = a.code;
              });
          }
        });
        stD.forEach(s => statuses[s.code.toUpperCase()] = s.description);
      }).catch(err => {
        document.getElementById("output").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + err;
      });
    }
    function capitalize(str) {
      return str
        ? str.split(/([ -])/g).map(w =>
            /[–ê-–ØA-Z–Å]/i.test(w.charAt(0))
              ? w.charAt(0).toUpperCase() + w.slice(1)
              : w
          ).join('')
        : '';
    }
    function matchRoute(rt) {
      for (let len = 3; len <= 4; len++) {
        const f = rt.slice(0, len), t = rt.slice(len);
        const fm = aliasMap[f] || (airports[f] ? f : null);
        const tm = aliasMap[t] || (airports[t] ? t : null);
        if (fm && tm) return [fm, tm];
      }
      return [null, null];
    }

    // ‚Äî‚Äî‚Äî –ó–ê–ú–ï–ù–ê ‚Ññ1: preprocessGDS ‚Äî‚Äî‚Äî
    function preprocessGDS(line) {
      return line
        // —É–±—Ä–∞—Ç—å –ª–∏–¥–∏—Ä—É—é—â—É—é –Ω—É–º–µ—Ä–∞—Ü–∏—é "1 . ", "2) " –∏–ª–∏ "4 "
        .replace(/^\s*\d+[\.\)]?\s*/, '')
        // —É–¥–∞–ª–∏—Ç—å . , # –∏ /
        .replace(/[.,#\/]/g, '')
        // —É–±—Ä–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ O*
        .replace(/\s+O\*/g, '')
        // —É–±—Ä–∞—Ç—å –æ–¥–∏–Ω–æ—á–Ω–æ–µ E
        .replace(/\s+E\b/g, '')
        // SU6321 ‚Üí SU-6321
        .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g, '$1-$2');
    }

    function extractDays(line) {
      const dm = {
        MO: "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", TU: "–≤—Ç–æ—Ä–Ω–∏–∫", WE: "—Å—Ä–µ–¥–∞",
        TH: "—á–µ—Ç–≤–µ—Ä–≥", FR: "–ø—è—Ç–Ω–∏—Ü–∞", SA: "—Å—É–±–±–æ—Ç–∞", SU: "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
      };
      const m = line.match(/\b(MO|TU|WE|TH|FR|SA|SU)(\/(MO|TU|WE|TH|FR|SA|SU))*\b/g);
      return m ? m[0].split('/').map(d => dm[d] || d).join(', ') : "";
    }

    function decode() {
      const text = preprocessGDS(document.getElementById("input").value.trim());
      const lines = text.split(/\n+/);
      const out = [];

      for (const raw of lines) {
        const line = raw.trim();
        if (!line) continue;

        // —Ç–æ–∫–µ–Ω—ã
        let tokens = line.toUpperCase().split(/\s+/);

        // ‚Äî‚Äî‚Äî –ó–ê–ú–ï–ù–ê ‚Ññ2: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º—É—Å–æ—Ä–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ ‚Äî‚Äî‚Äî
        tokens = tokens.filter(t =>
          // –Ω–µ –æ–¥–∏–Ω–æ—á–Ω–∞—è —Ü–∏—Ñ—Ä–∞
          !/^[0-9]$/.test(t) &&
          // –Ω–µ –æ–¥–∏–Ω –∏–∑ —Å–∏–º–≤–æ–ª–æ–≤ *, . , / #
          !/^[\*\.\,\/#]$/.test(t)
        );

        // –æ—Å—Ç–∞–ª—å–Ω–∞—è —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞: airline/flight, dateToken, routeToken, matchRoute,
        // –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ statusToken –∏–∑ tokens, dep/arr, —Å–±–æ—Ä–∫–∞ —Å—Ç—Ä–æ–∫–∏
        let airline = "", flight = "", dateToken = "", dep = "", arr = "", status = "";

        // flight & airline
        const cleaned = tokens.filter(t =>
          !/^\d{1,2}$/.test(t) &&
          !["*", ".", "O", "E", "SU", "MO", "TU", "WE", "TH", "FR", "SA",
            "–±–µ–∑", "–∏–∑–º–µ–Ω–µ–Ω–∏–π", "–æ—Ç–º–µ–Ω—ë–Ω", "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω", "–∏–∑–º–µ–Ω–µ–Ω–∏–µ"].includes(t)
        );
        for (let i = 0; i < cleaned.length - 1; i++) {
          if (/^[A-Z0-9]{2}$/.test(cleaned[i]) &&
              /^[0-9]{2,4}[A-Z]?$/.test(cleaned[i+1])) {
            airline = cleaned[i];
            flight  = cleaned[i+1];
            break;
          }
        }
        if (!airline && /^[A-Z0-9]{2}-[0-9]{2,4}$/.test(cleaned[0])) {
          [airline, flight] = cleaned[0].split("-");
        }

        // date
        dateToken = tokens.find(t => /^\d{2}[A-Z–ê-–Ø–Å]{3}(\d{2})?$/i.test(t)) || "";
        const months = {
          "–Ø–ù–í":"01","–§–ï–í":"02","–ú–ê–†":"03","–ê–ü–†":"04","–ú–ê–ô":"05","–ò–Æ–ù":"06",
          "–ò–Æ–õ":"07","–ê–í–ì":"08","–°–ï–ù":"09","–û–ö–¢":"10","–ù–û–Ø":"11","–î–ï–ö":"12",
          "JAN":"01","FEB":"02","MAR":"03","APR":"04","MAY":"05","JUN":"06",
          "JUL":"07","AUG":"08","SEP":"09","OCT":"10","NOV":"11","DEC":"12"
        };
        let formattedDate = "‚ö†Ô∏è";
        if (dateToken.length >= 5) {
          const d = dateToken.slice(0,2);
          const m = months[dateToken.slice(2,5).toUpperCase()] || "??";
          const y = dateToken.length === 7 ? "20"+dateToken.slice(5) : "2025";
          formattedDate = `${d}.${m}.${y}`;
        }

        // routeToken + –≤—à–∏—Ç—ã–π —Å—Ç–∞—Ç—É—Å
        let routeToken = tokens.find(t => /^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t)) || "";
        if (!routeToken) {
          const idx = tokens.findIndex((t,i) => aliasMap[t] && tokens[i+1]);
          if (idx >= 0) routeToken = tokens[idx] + tokens[idx+1];
        }
        for (let sc in statuses) {
          if (routeToken.endsWith(sc)) {
            const pr = routeToken.slice(0, -sc.length);
            tokens = tokens.map(t => t === routeToken ? pr : t);
            tokens.push(sc);
            break;
          }
        }
        const [fromCode,toCode] = matchRoute(isCyrillic(routeToken) ? normalizeCyrillic(routeToken) : routeToken);
        const from = airports[fromCode], to = airports[toCode];

        // statusToken
        const statusToken = tokens.slice(2).find(t => statuses[t.toUpperCase()]);
        status = statuses[statusToken?.toUpperCase()] || "";

        // times
        const times = tokens.map(t => t.match(/\d{4}$/) ? t.match(/\d{4}$/)[0] : null).filter(Boolean);
        dep = times[times.length - 2] || "";
        arr = times[times.length - 1] || "";
        if (dep.length === 4) dep = dep.slice(0,2) + ":" + dep.slice(2);
        if (arr.length === 4) arr = arr.slice(0,2) + ":" + arr.slice(2);

        // final
        if (airline && flight && from && to && dep && arr && formattedDate) {
          out.push(`${airline}-${flight} ${formattedDate}, ${from.city} ${from.iata} ${dep} ‚Äî ${to.city} ${to.iata} ${arr}${status ? " ‚Äî " + status : ""}`);
        } else {
          out.push("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: " + line);
        }
      }

      document.getElementById("output").textContent = out.join("\n");
    }

    function copyResult() {
      navigator.clipboard.writeText(document.getElementById("output").textContent);
    }
    function clearAll() {
      document.getElementById("input").value = "";
      document.getElementById("output").textContent = "";
    }

    init();
  </script>
</body>
</html>
