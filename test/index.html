
<!DOCTYPE html>
<html lang="ru">
<head>
<style>
  body.dark-mode {
    background-color: #121212;
    color: #eee;
  }

  body.dark-mode input,
  body.dark-mode textarea,
  body.dark-mode pre#output {
  background-color: #1e1e1e;
  color: #fff;
  border: 1px solid #444;
  }


  body.dark-mode button {
    background-color: #2c2c2c;
    color: #eee;
    border: 1px solid #555;
  }

  body.transition, body.transition * {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }

  .dark-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 14px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    background: #333;
    color: #eee;
    border: 1px solid #666;
    z-index: 1000;
  }
</style>

  <meta charset="UTF-8" />
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–æ–∫</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 150px; font-family: monospace; font-size: 14px; }
    button { padding: 10px 20px; font-size: 14px; margin-top: 10px; margin-right: 10px; }
    pre { background: #f0f0f0; padding: 15px; white-space: pre-wrap; border: 1px solid #ccc; }
  </style>
</head>
<body>

<style>
  #test-badge {
    position: fixed;
    top: 85px; /* moved down to avoid toggle button */
    right: 10px;
    background: #ff5722;
    color: white;
    padding: 5px 10px;
    font-size: 12px;
    font-weight: bold;
    z-index: 9999;
    border-radius: 3px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    opacity: 0.9;
  }
  body.dark-mode #test-badge {
    background: #ff7043;
    color: #fff;
  }
</style>
<div id="test-badge">–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú</div>


<style>
  #test-badge {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #ff5722;
    color: white;
    padding: 5px 10px;
    font-size: 12px;
    font-weight: bold;
    z-index: 9999;
    border-radius: 3px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }
</style>
<div id="test-badge">–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú</div>

<button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">
  üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
</button>
<script>
function toggleDarkMode() {
  document.body.classList.add('transition');
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  updateToggleIcon(isDark);
  setTimeout(() => document.body.classList.remove('transition'), 300);
}

function updateToggleIcon(isDark) {
  const btn = document.getElementById('theme-toggle');
  btn.innerHTML = isDark ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
}

window.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme');
  const isDark = savedTheme === 'dark';
  if (isDark) {
    document.body.classList.add('dark-mode');
  }
  updateToggleIcon(isDark);
});
</script>

  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea><br />
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>

<script>
let airports = {};
let aliasMap = {};
let statuses = {};

function isCyrillic(str) {
  return /[–ê-–Ø–Å–∞-—è—ë]/.test(str);
}

function normalizeCyrillic(str) {
  return str
    .replace(/C/g, "–°")
    .replace(/A/g, "–ê")
    .replace(/E/g, "–ï")
    .replace(/O/g, "–û")
    .replace(/K/g, "–ö")
    .replace(/M/g, "–ú")
    .replace(/H/g, "–ù")
    .replace(/X/g, "–•");
}

function fetchCSV(url) {
  return fetch(url)
    .then(response => response.text())
    .then(text => {
      const lines = text.trim().split(/\r?\n/);
      const [header, ...rows] = lines;
      const keys = header.split(',');
      return rows.map(row => {
        const values = row.split(',');
        const obj = {};
        keys.forEach((key, i) => obj[key.trim()] = values[i] ? values[i].trim() : "");
        return obj;
      });
    });
}

function init() {
  Promise.all([
    fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv?v=" + Date.now()),
    fetchCSV("https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv?v=" + Date.now())
  ]).then(([airportData, statusData]) => {
    airportData.forEach(a => {
      airports[a.code] = { city: capitalize(a.city), iata: a.iata };
      if (a.alias) {
        a.alias
        .split(' ')
        .map(alias => alias.trim())
        .filter(alias => alias.length > 0)
        .forEach(alias => {
          const normalized = isCyrillic(alias) ? normalizeCyrillic(alias) : alias;
          aliasMap[normalized.toUpperCase()] = a.code;
    });
}

    });
    statusData.forEach(s => {
      statuses[s.code.toUpperCase()] = s.description;
    });
  }).catch(err => {
    document.getElementById("output").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + err;
  });
}

function capitalize(str) {
  return str
    ? str
        .split(/([ -])/g)
        .map(w =>
          /[–ê-–ØA-Z–Å]/i.test(w.charAt(0))
            ? w.charAt(0).toUpperCase() + w.slice(1)
            : w
        )
        .join('')
    : '';
}

function matchRoute(routeToken) {
  for (let len = 3; len <= 4; len++) {
    let from = routeToken.slice(0, len);
    let to = routeToken.slice(len);
    const fromMatch = aliasMap[from] || (airports[from] ? from : null);
    const toMatch = aliasMap[to] || (airports[to] ? to : null);
    if (fromMatch && toMatch) {
      return [fromMatch, toMatch];
    }
  }
  return [null, null];
}


function preprocessGDS(line) {
  return line
    .replace(/[.,#]/g, '')          // —É–¥–∞–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã
    .replace(/\s+O\*/g, '')       // —É–±–∏—Ä–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ
    .replace(/\s+E\b/g, '')       // "E" ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
    .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g, '$1-$2'); // SU6321 ‚Üí SU-6321
}

function extractDays(line) {
  const daysMap = { MO: "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", TU: "–≤—Ç–æ—Ä–Ω–∏–∫", WE: "—Å—Ä–µ–¥–∞", TH: "—á–µ—Ç–≤–µ—Ä–≥", FR: "–ø—è—Ç–Ω–∏—Ü–∞", SA: "—Å—É–±–±–æ—Ç–∞", SU: "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ" };
  const match = line.match(/\b(MO|TU|WE|TH|FR|SA|SU)(\/(MO|TU|WE|TH|FR|SA|SU))*\b/g);
  if (!match) return "";
  return match[0].split('/').map(d => daysMap[d] || d).join(', ');
}


function decode() {

  // üí¨ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è GDS
  const serviceMatch = line.match(/^(SSR|FLIFO|OSI)\\s+(.*?)\\s*$/i);
  if (serviceMatch) {
    const type = serviceMatch[1].toUpperCase();
    const content = serviceMatch[2];
    const resultText = `üí¨ –°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ [${type}]: ${content}`;
    document.getElementById("extended-content").textContent = resultText;
    return;
  }


  // üí¨ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è GDS
  if (serviceMatch) {
    const type = serviceMatch[1].toUpperCase();
    const content = serviceMatch[2];
    const resultText = `üí¨ –°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ [${type}]: ${content}`;
    output.push(resultText);
    document.getElementById("extended-content").textContent = resultText;
    return;
  }

  const IS_TEST = true;
  const DEBUG = true;
  const junkSymbols = ["*", ".", ","];

  const text = preprocessGDS(document.getElementById("input").value.trim());
  const output = [];
  const lines = text.split(/\n+/);

  for (const line of lines) {
    let tokens = line.trim().toUpperCase().split(/\s+/);
    const junkSymbols = ["*", ".", ","];
    tokens = tokens.filter(t => !/^\d$/.test(t) && !junkSymbols.includes(t));

    let airline = "", flight = "", dateToken = "", dep = "", arr = "", status = "";

const cleaned = tokens.filter(t =>
  !/^\d{1,2}$/.test(t) &&
  !["*", ".", "O", "E", "SU", "MO", "TU", "WE", "TH", "FR", "SA", "–±–µ–∑", "–∏–∑–º–µ–Ω–µ–Ω–∏–π", "–æ—Ç–º–µ–Ω—ë–Ω", "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω", "–∏–∑–º–µ–Ω–µ–Ω–∏–µ"].includes(t.toUpperCase())
);

for (let i = 0; i < cleaned.length - 1; i++) {
  const maybeAirline = cleaned[i];
  const maybeFlight = cleaned[i + 1];

  if (
  /^[A-Z0-9]{2}$/.test(maybeAirline) &&
  /^[0-9]{2,4}[A-Z]?$/.test(maybeFlight)
) {
    airline = maybeAirline;
    flight = maybeFlight;
    break;
  }
}


  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–∏–ø–∞ 'FV*SU -6301'
  if (!airline && !flight) {
    const match = line.match(/\b([A-Z0-9]{2})\*([A-Z0-9]{2})\s*-?(\d{3,4})\b/);
    if (match) {
      airline = match[2];
      flight = match[3];
    }
  }


  if (!airline && /^[A-Z0-9]{2}-[0-9]{2,4}$/.test(cleaned[0])) {
  [airline, flight] = cleaned[0].split("-");
}

    let fromCode = "", toCode = "";

    dateToken = tokens.find(t => /^\d{2}[A-Z–ê-–Ø–Å]{3}(\d{2})?$/i.test(t)) || "";
    const months = {
      "–Ø–ù–í":"01","–§–ï–í":"02","–ú–ê–†":"03","–ê–ü–†":"04","–ú–ê–ô":"05","–ò–Æ–ù":"06",
      "–ò–Æ–õ":"07","–ê–í–ì":"08","–°–ï–ù":"09","–û–ö–¢":"10","–ù–û–Ø":"11","–î–ï–ö":"12",
      "JAN":"01","FEB":"02","MAR":"03","APR":"04","MAY":"05","JUN":"06",
      "JUL":"07","AUG":"08","SEP":"09","OCT":"10","NOV":"11","DEC":"12"
    };
    let formattedDate = "‚ö†Ô∏è";
    if (dateToken.length >= 5) {
      const d = dateToken.slice(0,2);
      const m = months[dateToken.slice(2,5).toUpperCase()] || "??";
      const y = dateToken.length === 7 ? "20"+dateToken.slice(5) : "2025";
      formattedDate = `${d}.${m}.${y}`;
    }

    let routeToken = tokens.find(t => /^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t)) || "";

    if (!routeToken) {
      const idx = tokens.findIndex((t, i) => aliasMap[t] && aliasMap[tokens[i + 1]]);
      if (idx >= 0) routeToken = tokens[idx] + tokens[idx + 1];
}

  for (let statusCode in statuses) {
    if (routeToken.endsWith(statusCode)) {
      const pureRoute = routeToken.slice(0, -statusCode.length);
      const from = pureRoute.slice(0, 3);
      const to = pureRoute.slice(3);

    if ((aliasMap[from] || airports[from]) && (aliasMap[to] || airports[to])) {
      tokens = tokens.map(t => {
        if (t === routeToken) {
          routeToken = pureRoute;
          return pureRoute;
        }
        return t;
      });
      tokens.push(statusCode);
    statusToken = statusCode;
      break;
    }
  }
}

    
    [fromCode, toCode] = matchRoute(isCyrillic(routeToken) ? normalizeCyrillic(routeToken) : routeToken);

    const from = airports[fromCode?.toUpperCase()];
    const to = airports[toCode?.toUpperCase()];

    const statusToken = tokens
      .slice(2) 
      .find(t => statuses[t.toUpperCase()]);

    status = statuses[statusToken?.toUpperCase()] || "";

    const times = tokens
    .map(t => t.match(/\d{4}$/) ? t.match(/\d{4}$/)[0] : null)
    .filter(Boolean);

    dep = times[times.length - 2] || "";
    arr = times[times.length - 1] || "";

    if (dep.length === 4) dep = dep.slice(0,2) + ":" + dep.slice(2);
    if (arr.length === 4) arr = arr.slice(0,2) + ":" + arr.slice(2);

    console.log("üß© routeToken:", routeToken);
    console.log("‚úÖ fromCode:", fromCode, "‚Üí", airports[fromCode?.toUpperCase()]);
    console.log("‚úÖ toCode:", toCode, "‚Üí", airports[toCode?.toUpperCase()]);
    console.log("‚úÖ dep:", dep, "‚úÖ arr:", arr);
    console.log("‚úÖ status:", statusToken, "‚Üí", statuses[statusToken?.toUpperCase()]);
    console.log("‚úÖ dateToken:", dateToken);
    console.log("‚úÖ formattedDate:", formattedDate);
    console.log("‚úÖ airline:", airline);
    console.log("‚úÖ flight:", flight);
    
    if (airline && flight && from && to && dep && arr && formattedDate) {
      const daysText = extractDays(line); output.push(`${airline}-${flight} ${formattedDate}, ${from.city} ${from.iata} ${dep} ‚Äî ${to.city} ${to.iata} ${arr}${status ? " ‚Äî " + status : ""}`);

  // üß™ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  let extendedInfo = '';
  extendedInfo += `üì¶ –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: ${line}\n`;
  extendedInfo += `‚úàÔ∏è –ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è: ${airline || '‚ùì'}\n`;
  extendedInfo += `üî¢ –†–µ–π—Å: ${flight || '‚ùì'}\n`;
  extendedInfo += `üìÖ –î–∞—Ç–∞: ${formattedDate || '‚ùì'}\n`;
  extendedInfo += `üìç –û—Ç–∫—É–¥–∞: ${from?.city || '‚ùì'} (${from?.iata || '??'})\n`;
  extendedInfo += `üìç –ö—É–¥–∞: ${to?.city || '‚ùì'} (${to?.iata || '??'})\n`;
  extendedInfo += `‚è∞ –í—Ä–µ–º—è: ${dep || '??:??'} ‚Üí ${arr || '??:??'}\n`;
  extendedInfo += `üìå –°—Ç–∞—Ç—É—Å: ${status || '‚ùì'}\n`;

  document.getElementById("extended-content").textContent = extendedInfo;

    } else {
      output.push("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: " + line);
    }
  }

  document.getElementById("output").textContent = output.join("\n");
}

function copyResult() {
  navigator.clipboard.writeText(document.getElementById("output").textContent);
}

function clearAll() {
  document.getElementById("input").value = "";
  document.getElementById("output").textContent = "";
}

init();
</script>
</body>
</html>
