<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–æ–∫</title>
  <style>
    /* ‚Äî‚Äî‚Äî –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Äî‚Äî‚Äî */
    body.dark-mode { background:#121212; color:#eee }
    body.dark-mode textarea,
    body.dark-mode pre#output {
      background:#1e1e1e; color:#fff; border:1px solid #444;
    }
    body.dark-mode button {
      background:#2c2c2c; color:#eee; border:1px solid #555;
    }
    .dark-toggle {
      position:absolute; top:10px; right:10px;
      padding:6px 12px; background:#333; color:#eee;
      border:1px solid #666; border-radius:6px; cursor:pointer;
      z-index:1000;
    }
    body.transition, body.transition * {
      transition: background-color .3s, color .3s, border-color .3s;
    }
    /* ‚Äî‚Äî‚Äî –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ ‚Äî‚Äî‚Äî */
    body { font-family:sans-serif; padding:20px; max-width:900px; margin:auto }
    textarea { width:100%; height:150px; font-family:monospace; font-size:14px }
    button { margin:5px 5px 0 0; padding:8px 16px; font-size:14px }
    pre { background:#f0f0f0; padding:10px; white-space:pre-wrap; border:1px solid #ccc }
  </style>
</head>
<body>
  <button id="theme-toggle" class="dark-toggle" onclick="toggleDarkMode()">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>

  <script>
    function toggleDarkMode(){
      document.body.classList.add('transition');
      const dark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', dark?'dark':'light');
      document.getElementById('theme-toggle').textContent = dark?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
      setTimeout(()=>document.body.classList.remove('transition'),300);
    }
    window.addEventListener('DOMContentLoaded',()=>{
      const dark = localStorage.getItem('theme')==='dark';
      if(dark) document.body.classList.add('dark-mode');
      document.getElementById('theme-toggle').textContent = dark?'‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞':'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
    });
  </script>

  <h2>–î–µ—à–∏—Ñ—Ä–æ–≤—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π 2.0</h2>
  <textarea id="input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º‚Ä¶"></textarea><br>
  <button onclick="decode()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="copyResult()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <pre id="output"></pre>

  <script>
    let airports={}, aliasMap={}, statuses={};

    function fetchCSV(url){
      return fetch(url).then(r=>r.text()).then(txt=>{
        const [hdr,...rows] = txt.trim().split(/\r?\n/);
        const keys = hdr.split(',').map(k=>k.trim());
        return rows.map(r=>{
          const vals=r.split(',');
          const obj={};
          keys.forEach((k,i)=>obj[k]=vals[i]?.trim()||"");
          return obj;
        });
      });
    }
    function capitalize(s){
      return s? s.split(/([ -])/g).map(w=>
        /[–ê-–Ø–ÅA-Z]/i.test(w[0])? w[0].toUpperCase()+w.slice(1): w
      ).join('') : '';
    }
    function isCyrillic(s){ return /[–ê-–Ø–Å–∞-—è—ë]/.test(s); }
    function normalizeCyrillic(s){
      return s.replace(/C/g,'–°').replace(/A/g,'–ê').replace(/E/g,'–ï')
              .replace(/O/g,'–û').replace(/K/g,'–ö').replace(/M/g,'–ú')
              .replace(/H/g,'–ù').replace(/X/g,'–•');
    }
    function matchRoute(rt){
      for(let len=3;len<=4;len++){
        const f=rt.slice(0,len), t=rt.slice(len);
        const fm=aliasMap[f]|| (airports[f]?f:null),
              tm=aliasMap[t]|| (airports[t]?t:null);
        if(fm&&tm) return [fm,tm];
      }
      return [null,null];
    }

    function init(){
      Promise.all([
        fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/airports_cleaned.csv'),
        fetchCSV('https://raw.githubusercontent.com/aivashurov/decoder/refs/heads/main/statuses_cleaned.csv')
      ]).then(([ap,st])=>{
        ap.forEach(a=>{
          airports[a.code] = { city: capitalize(a.city), iata: a.iata };
          if(a.alias){
            a.alias.split(' ').filter(x=>x).forEach(alias=>{
              const norm = isCyrillic(alias)? normalizeCyrillic(alias): alias;
              aliasMap[norm.toUpperCase()] = a.code;
            });
          }
        });
        st.forEach(s=>statuses[s.code.toUpperCase()]=s.description);
      }).catch(e=>{
        document.getElementById('output').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e;
      });
    }

    // ‚Äî‚Äî‚Äî –ü–†–ê–í–ö–ê preprocessGDS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function preprocessGDS(line){
      return line
        // —É–±—Ä–∞—Ç—å "1 . ", "2) ", "4  " –∏ —Ç.–ø., –Ω–æ –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –∫–æ–¥ "6H"
        .replace(/^\s*\d+(?:[.\)]\s+|\s+)/, '')
        // —É–¥–∞–ª–∏—Ç—å . , # /
        .replace(/[.,#\/]/g,'')
        // —É–±—Ä–∞—Ç—å O*
        .replace(/\s+O\*/g,'')
        // —É–±—Ä–∞—Ç—å –æ–¥–∏–Ω–æ—á–Ω–æ–µ E
        .replace(/\s+E\b/g,'')
        // SU6321‚ÜíSU-6321
        .replace(/\b([A-Z0-9]{2})(\d{3,4}[A-Z]?)\b/g,'$1-$2');
    }

    function extractDays(line){
      const dm={MO:'–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',TU:'–≤—Ç–æ—Ä–Ω–∏–∫',WE:'—Å—Ä–µ–¥–∞',TH:'—á–µ—Ç–≤–µ—Ä–≥',FR:'–ø—è—Ç–Ω–∏—Ü–∞',SA:'—Å—É–±–±–æ—Ç–∞',SU:'–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'};
      const m=line.match(/\b(MO|TU|WE|TH|FR|SA|SU)(\/(MO|TU|WE|TH|FR|SA|SU))*\b/g);
      return m? m[0].split('/').map(d=>dm[d]||d).join(', '): '';
    }

    function decode(){
      const raw = document.getElementById('input').value||'';
      const text = preprocessGDS(raw);
      const lines = text.split(/\n+/);
      const out=[];

      for(const rawLine of lines){
        const line = rawLine.trim();
        if(!line) continue;

        let tokens = line.toUpperCase().split(/\s+/);

        // ‚Äî‚Äî‚Äî –ü–†–ê–í–ö–ê —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî 
        tokens = tokens.filter(t=>
          !/^[0-9]$/.test(t) &&    // –Ω–µ –æ–¥–∏–Ω–æ—á–Ω–∞—è —Ü–∏—Ñ—Ä–∞
          !/^[\*\.\,\/#]$/.test(t) // –Ω–µ —Å–∏–º–≤–æ–ª *, . , / #
        );

        // airline/flight
        let airline='', flight='';
        const cleaned = tokens.filter(t=>
          !/^\d{1,2}$/.test(t) &&
          !["*",".","O","E","SU","MO","TU","WE","TH","FR","SA",
            "–±–µ–∑","–∏–∑–º–µ–Ω–µ–Ω–∏–π","–æ—Ç–º–µ–Ω—ë–Ω","–ø—Ä–µ–¥–ª–æ–∂–µ–Ω","–∏–∑–º–µ–Ω–µ–Ω–∏–µ"].includes(t)
        );
        for(let i=0;i<cleaned.length-1;i++){
          if(/^[A-Z0-9]{2}$/.test(cleaned[i]) && /^[0-9]{2,4}[A-Z]?$/.test(cleaned[i+1])){
            airline=cleaned[i]; flight=cleaned[i+1]; break;
          }
        }
        if(!airline && /^[A-Z0-9]{2}-\d{2,4}$/.test(cleaned[0])){
          [airline,flight] = cleaned[0].split('-');
        }

        // date
        let dateToken = tokens.find(t=>/^\d{2}[A-Z–ê-–Ø–Å]{3}(\d{2})?$/.test(t))||'';
        let formattedDate='‚ö†Ô∏è';
        if(dateToken){
          const d=dateToken.slice(0,2),
                m=dateToken.slice(2,5).toUpperCase(),
                y=dateToken.length===7?('20'+dateToken.slice(5)):new Date().getFullYear();
          const mm = {
            –Ø–ù–í:'01',–§–ï–í:'02',–ú–ê–†:'03',–ê–ü–†:'04',–ú–ê–ô:'05',–ò–Æ–ù:'06',
            –ò–Æ–õ:'07',–ê–í–ì:'08',–°–ï–ù:'09',–û–ö–¢:'10',–ù–û–Ø:'11',–î–ï–ö:'12',
            JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',
            JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'
          }[m]||'??';
          formattedDate=`${d}.${mm}.${y}`;
        }

        // –º–∞—Ä—à—Ä—É—Ç + –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        let routeToken = tokens.find(t=>/^[A-Z–ê-–Ø–Å]{6,8}$/i.test(t))||'';
        if(!routeToken){
          const idx = tokens.findIndex((t,i)=>aliasMap[t]&&tokens[i+1]);
          if(idx>=0) routeToken = tokens[idx]+tokens[idx+1];
        }
        for(let sc in statuses){
          if(routeToken.endsWith(sc)){
            const pure = routeToken.slice(0,-sc.length);
            tokens = tokens.map(t=>t===routeToken?pure:t);
            tokens.push(sc);
            routeToken = pure;
            break;
          }
        }
        const [fromCode,toCode] = matchRoute(isCyrillic(routeToken)?normalizeCyrillic(routeToken):routeToken);
        const from = airports[fromCode], to = airports[toCode];

        // status
        const statusToken = tokens.slice(2).find(t=>statuses[t.toUpperCase()]);
        const status = statuses[statusToken?.toUpperCase()]||'';

        // times
        const times = tokens.map(t=>t.match(/^\d{4}$/)?t:null).filter(Boolean);
        let dep = times[times.length-2]||'', arr = times[times.length-1]||'';
        if(dep.length===4) dep = dep.slice(0,2)+':'+dep.slice(2);
        if(arr.length===4) arr = arr.slice(0,2)+':'+arr.slice(2);

        if(airline&&flight&&from&&to&&dep&&arr&&formattedDate){
          out.push(`${airline}-${flight} ${formattedDate}, ${from.city} ${from.iata} ${dep} ‚Äî ${to.city} ${to.iata} ${arr}${status?' ‚Äî '+status:''}`);
        } else {
          out.push(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫—É: ${line}`);
        }
      }

      document.getElementById('output').textContent = out.join('\n');
    }

    function copyResult(){ navigator.clipboard.writeText(document.getElementById('output').textContent); }
    function clearAll(){
      document.getElementById('input').value='';
      document.getElementById('output').textContent='';
    }

    init();
  </script>
</body>
</html>
